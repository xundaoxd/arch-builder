#!/bin/bash
set -e

root_prefix="/"
vols=(root)

die() {
    echo "$@"
    exit 1
}

init() {
    snapshot_prefix="${root_prefix}/mnt/volumes/snapshots"
}

print_usage() {
    cat << EOF
$0 -s [label]               snapshot volume
EOF
}

# checkout [label]
checkout() {
    init
    label="$1"
    [[ -z "$label" ]] && label=$(date +%y%m%d%H%M%S)

    for vol in "${vols[@]}"; do
        [[ ! -e "$snapshot_prefix/$vol.current" ]] && die "volume $vol does not exist"
    done

    for vol in "${vols[@]}"; do
        if [[ ! -e "${snapshot_prefix}/${vol}.${label}" ]]; then
            btrfs subvol snapshot -r "${snapshot_prefix}/$(readlink "${snapshot_prefix}/${vol}.current")" "${snapshot_prefix}/${vol}.${label}"
        fi
        rm "${snapshot_prefix}/${vol}.current"
        ln -s "${vol}.${label}" "${snapshot_prefix}/${vol}.current"
    done
}


while (( $# )); do
case $1 in
    -h | --help)
        print_usage
        exit
        ;;
    -p | --prefix)
        root_prefix="$2"
        shift 2
        ;;
    -c | --checkout)
        shift
        checkout "$@"
        exit
        ;;
    *)
        print_usage
        exit 1
        ;;
esac
done
